import os
from pytest import approx
from mcnp_inputs import HomogeneousInput, build_pyne_matlib

if os.environ.get('APP_ENV') == 'docker':
    nucdata = '/root/.local/lib/python3.5/site-packages/pyne/nuc_data.h5'
    matlib = build_pyne_matlib(nucdata)
else:
    matlib = build_pyne_matlib()

def test_norm_comp():
    # build example input file
    obs = HomogeneousInput(15, 0.6, 150, matlib)
    obs.calc_vol_vfrac()
    obs.homog_core()
    
    obs_total_frac = 0
    for isotope in obs.homog_mat: 
        obs_total_frac += obs.homog_mat[isotope]

    assert obs_total_frac == approx(1, abs=1e-7)

def test_homog_comp():
    """Test fuel, clad, coolant homogenization process.
    """
    exp_comp = {
        50100000 : 4.36075073231383E-07,
        50110000 : 1.92993563688806E-06,
        60120000 : 0.001094775415103,
        60130000 : 1.2830888245035E-05,
        70150000 : 0.027770827,
        80160000 : 0.002851106,
        130270000 : 0.000236598705025,
        140280000 : 0.000138239891372,
        140290000 : 7.2735173898753E-06,
        140300000 : 4.96573362106248E-06,
        150310000 : 6.62476374069704E-06,
        160320000 : 6.27459765726019E-06,
        160330000 : 5.10911243630757E-08,
        160340000 : 2.98261059528482E-07,
        160360000 : 7.43109212742188E-10,
        220460000 : 3.3729984585759E-05,
        220470000 : 3.10796058920701E-05,
        220480000 : 0.000314491730693,
        220490000 : 2.3560499046379E-05,
        220500000 : 2.30182148144619E-05,
        240500000 : 0.000375245546169,
        240520000 : 0.007525258412022,
        240530000 : 0.000869736839672,
        240540000 : 0.000220576240721,
        250550000 : 0.000150476776396,
        260540000 : 0.000454146482321,
        260560000 : 0.007392763137208,
        260570000 : 0.000173786480815,
        260580000 : 2.35335267940061E-05,
        270590000 : 0.000430609643145,
        280580000 : 0.016693931429147,
        280600000 : 0.00665173599307,
        280610000 : 0.000293978622968,
        280620000 : 0.000952688345653,
        280640000 : 0.000250425533347,
        290630000 : 8.84642558088079E-05,
        290650000 : 4.07195835296044E-05,
        410930000 : 0.002425136726505,
        420920000 : 0.000200848640696,
        420940000 : 0.000129230212685,
        420950000 : 0.000226098454496,
        420960000 : 0.000240450531943,
        420970000 : 0.000139919742178,
        420980000 : 0.00035914737028,
        421000000 : 0.000147557148376,
        741800000 : 0.000527607417641,
        741820000 : 0.117806570257708,
        741830000 : 0.063967795288825,
        741840000 : 0.137709758301018,
        741860000 : 0.129170836958131,
        922350000 : 0.424617185,
        922380000 : 0.047179687
               }

    # build example input file
    obs = HomogeneousInput(15, 0.6, 150, matlib)
    obs.calc_vol_vfrac()
    obs.homog_core()
    obs.write_mat_string()
    obs_mat = obs.homog_mat
    
    # compare compositions
    for iso in obs_mat:
        assert exp_comp[iso] == approx(obs_mat[iso], abs=1e-5)
    
